<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Risk Stratification Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #ecf0f1;
            --dark-bg: #34495e;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .navbar {
            background: rgba(44, 62, 80, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .risk-high { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .risk-moderate { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .risk-low { background: linear-gradient(135deg, #27ae60, #2ecc71); }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .form-control {
            border-radius: 10px;
            border: 2px solid #ecf0f1;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .table {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .table thead th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 15px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .food-recommendations {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .food-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .food-item:hover {
            transform: translateY(-3px);
        }

        .risk-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            border-radius: 15px;
            border: none;
            padding: 15px 20px;
        }

        .feature-icon {
            font-size: 2em;
            margin-bottom: 15px;
            color: var(--secondary-color);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-heartbeat me-2"></i>
                <strong>Healthcare Risk Stratification</strong>
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="fas fa-chart-line me-2"></i>
                    AI-Powered Risk Assessment
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="text-center mb-3">
                        <i class="fas fa-user-md me-3"></i>
                        Healthcare Risk Stratification Dashboard
                    </h1>
                    <p class="text-center text-muted">
                        Advanced AI-powered risk assessment with personalized care recommendations
                    </p>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-users feature-icon"></i>
                        <h3 id="totalPatients">0</h3>
                        <p>Total Patients</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card risk-high">
                        <i class="fas fa-exclamation-triangle feature-icon"></i>
                        <h3 id="highRiskPatients">0</h3>
                        <p>High Risk Patients</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card risk-moderate">
                        <i class="fas fa-chart-bar feature-icon"></i>
                        <h3 id="moderateRiskPatients">0</h3>
                        <p>Moderate Risk</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card risk-low">
                        <i class="fas fa-shield-alt feature-icon"></i>
                        <h3 id="lowRiskPatients">0</h3>
                        <p>Low Risk Patients</p>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-pie me-2"></i>Risk Distribution</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="riskDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-line me-2"></i>Risk Trends</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="riskTrendsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Patient Prediction Form -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-user-plus me-2"></i>New Patient Risk Assessment</h5>
                        </div>
                        <div class="card-body">
                            <form id="predictionForm">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label class="form-label">Age</label>
                                        <input type="number" class="form-control" name="AGE" required min="18" max="120">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Gender</label>
                                        <select class="form-control" name="GENDER" required>
                                            <option value="">Select Gender</option>
                                            <option value="1">Male</option>
                                            <option value="0">Female</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">BMI</label>
                                        <input type="number" class="form-control" name="BMI" step="0.1" min="15" max="50">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Glucose Level</label>
                                        <input type="number" class="form-control" name="GLUCOSE" min="50" max="500">
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Blood Pressure (Systolic)</label>
                                        <input type="number" class="form-control" name="BP_S" min="70" max="200">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">HbA1c</label>
                                        <input type="number" class="form-control" name="HbA1c" step="0.1" min="4" max="15">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Cholesterol</label>
                                        <input type="number" class="form-control" name="CHOLESTEROL" min="100" max="400">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Total Claims Cost</label>
                                        <input type="number" class="form-control" name="TOTAL_CLAIMS_COST" step="0.01" min="0">
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <h6>Medical Conditions:</h6>
                                        <div class="row">
                                            <div class="col-md-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="ALZHEIMER" value="1">
                                                    <label class="form-check-label">Alzheimer's</label>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="HEARTFAILURE" value="1">
                                                    <label class="form-check-label">Heart Failure</label>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="CANCER" value="1">
                                                    <label class="form-check-label">Cancer</label>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="STROKE" value="1">
                                                    <label class="form-check-label">Stroke</label>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="RENAL_DISEASE" value="1">
                                                    <label class="form-check-label">Renal Disease</label>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="PULMONARY" value="1">
                                                    <label class="form-check-label">Pulmonary</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12 text-center">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="fas fa-calculator me-2"></i>
                                            Predict Risk & Generate Recommendations
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prediction Results -->
            <div id="predictionResults" style="display: none;">
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-area me-2"></i>Risk Assessment Results</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 text-center">
                                        <div class="risk-score-display">
                                            <h2 id="riskScore">0%</h2>
                                            <span class="risk-indicator" id="riskLabel">Low Risk</span>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="chart-container">
                                            <canvas id="riskScoreChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <h6>Top Risk Factors:</h6>
                                        <ul id="topFeatures" class="list-group list-group-flush"></ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>AI Recommendations:</h6>
                                        <ul id="aiRecommendations" class="list-group list-group-flush"></ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="food-recommendations">
                            <h5><i class="fas fa-apple-alt me-2"></i>Nutritional Recommendations</h5>
                            <div id="foodRecommendations"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Patient Data Table -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-table me-2"></i>Patient Database</h5>
                            <div>
                                <button class="btn btn-outline-light btn-sm" onclick="exportToCSV()">
                                    <i class="fas fa-download me-1"></i>Export CSV
                                </button>
                                <button class="btn btn-outline-light btn-sm" onclick="sendBulkEmails()">
                                    <i class="fas fa-envelope me-1"></i>Send Bulk Emails
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="patientTable">
                                    <thead>
                                        <tr>
                                            <th>Patient ID</th>
                                            <th>Age</th>
                                            <th>Gender</th>
                                            <th>Risk Score</th>
                                            <th>Risk Level</th>
                                            <th>Top Features</th>
                                            <th>Email</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="patientTableBody">
                                        <!-- Data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div>
                                    <label class="form-label">Show:</label>
                                    <select class="form-select form-select-sm d-inline-block w-auto ms-2" id="limitSelect">
                                        <option value="50">50</option>
                                        <option value="100" selected>100</option>
                                        <option value="500">500</option>
                                        <option value="1000">1000</option>
                                    </select>
                                </div>
                                <div>
                                    <button class="btn btn-primary btn-sm" onclick="loadPatientData()">
                                        <i class="fas fa-sync-alt me-1"></i>Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <p>Processing your request...</p>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let patientData = [];
        let riskDistributionChart, riskTrendsChart, riskScoreChart;

        // Initialize charts
        function initializeCharts() {
            // Risk Distribution Chart
            const riskCtx = document.getElementById('riskDistributionChart').getContext('2d');
            riskDistributionChart = new Chart(riskCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Very High Risk', 'High Risk', 'Moderate Risk', 'Low Risk', 'Very Low Risk'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            '#e74c3c',
                            '#f39c12',
                            '#f1c40f',
                            '#2ecc71',
                            '#27ae60'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Risk Trends Chart
            const trendsCtx = document.getElementById('riskTrendsChart').getContext('2d');
            riskTrendsChart = new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: ['30 Days', '60 Days', '90 Days'],
                    datasets: [{
                        label: 'Average Risk Score',
                        data: [0, 0, 0],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Load patient data
        async function loadPatientData() {
            showLoading();
            try {
                const limit = document.getElementById('limitSelect').value;
                const response = await fetch(`/api/data?limit=${limit}`);
                const data = await response.json();
                
                patientData = data.data;
                updatePatientTable(patientData);
                updateStatistics(data.summary);
                updateCharts(data.summary);
                
                hideLoading();
            } catch (error) {
                console.error('Error loading data:', error);
                hideLoading();
                showAlert('Error loading patient data', 'danger');
            }
        }

        // Update patient table
        function updatePatientTable(patients) {
            const tbody = document.getElementById('patientTableBody');
            tbody.innerHTML = '';

            patients.forEach(patient => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${patient.patient_id}</td>
                    <td>${patient.age}</td>
                    <td>${patient.gender === 1 ? 'Male' : 'Female'}</td>
                    <td>${patient.risk_30d}%</td>
                    <td><span class="risk-indicator ${getRiskClass(patient.risk_label)}">${patient.risk_label}</span></td>
                    <td>${patient.top_3_features || 'N/A'}</td>
                    <td>
                        <input type="email" class="form-control form-control-sm" 
                               value="${patient.email || ''}" 
                               onchange="updatePatientEmail('${patient.patient_id}', this.value)"
                               placeholder="Enter email">
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="sendEmail('${patient.patient_id}')">
                            <i class="fas fa-envelope"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="generatePDF('${patient.patient_id}')">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update statistics
        function updateStatistics(summary) {
            document.getElementById('totalPatients').textContent = summary.total_patients.toLocaleString();
            document.getElementById('highRiskPatients').textContent = summary.high_risk_count.toLocaleString();
            document.getElementById('moderateRiskPatients').textContent = summary.moderate_risk_count.toLocaleString();
            document.getElementById('lowRiskPatients').textContent = summary.low_risk_count.toLocaleString();
        }

        // Update charts
        function updateCharts(summary) {
            // Update risk distribution chart
            riskDistributionChart.data.datasets[0].data = [
                summary.very_high_risk_count,
                summary.high_risk_count,
                summary.moderate_risk_count,
                summary.low_risk_count,
                summary.very_low_risk_count
            ];
            riskDistributionChart.update();

            // Update risk trends chart
            riskTrendsChart.data.datasets[0].data = [
                summary.avg_risk_30d,
                summary.avg_risk_60d,
                summary.avg_risk_90d
            ];
            riskTrendsChart.update();
        }

        // Handle form submission
        document.getElementById('predictionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            showLoading();

            const formData = new FormData(this);
            const patientData = {};
            
            for (let [key, value] of formData.entries()) {
                patientData[key] = value === '' ? 0 : parseFloat(value) || 0;
            }

            try {
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(patientData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    displayPredictionResults(result.predictions);
                    showAlert('Patient data saved and prediction completed successfully!', 'success');
                    loadPatientData(); // Refresh the table
                } else {
                    showAlert(result.error || 'Prediction failed', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error during prediction', 'danger');
            } finally {
                hideLoading();
            }
        });

        // Display prediction results
        function displayPredictionResults(predictions) {
            document.getElementById('predictionResults').style.display = 'block';
            
            // Update risk score display
            document.getElementById('riskScore').textContent = predictions.RISK_30D + '%';
            document.getElementById('riskLabel').textContent = predictions.RISK_LABEL;
            document.getElementById('riskLabel').className = `risk-indicator ${getRiskClass(predictions.RISK_LABEL)}`;

            // Update top features
            const topFeaturesList = document.getElementById('topFeatures');
            topFeaturesList.innerHTML = '';
            const features = predictions.TOP_3_FEATURES.split(', ');
            features.forEach(feature => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.innerHTML = `<i class="fas fa-exclamation-triangle text-warning me-2"></i>${feature}`;
                topFeaturesList.appendChild(li);
            });

            // Update AI recommendations
            const recommendationsList = document.getElementById('aiRecommendations');
            recommendationsList.innerHTML = '';
            const recommendations = predictions.AI_RECOMMENDATIONS.split(' | ');
            recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.innerHTML = `<i class="fas fa-lightbulb text-info me-2"></i>${rec}`;
                recommendationsList.appendChild(li);
            });

            // Generate food recommendations
            generateFoodRecommendations(predictions.RISK_LABEL, predictions.TOP_3_FEATURES);

            // Create risk score chart
            createRiskScoreChart(predictions);
        }

        // Generate food recommendations
        function generateFoodRecommendations(riskLevel, topFeatures) {
            const foodContainer = document.getElementById('foodRecommendations');
            foodContainer.innerHTML = '';

            const foodRecommendations = {
                'Very High Risk': {
                    title: 'Critical Care Nutrition',
                    foods: [
                        { name: 'Omega-3 Rich Fish', benefit: 'Heart health & inflammation reduction' },
                        { name: 'Leafy Greens', benefit: 'Blood pressure management' },
                        { name: 'Berries', benefit: 'Antioxidant protection' },
                        { name: 'Nuts & Seeds', benefit: 'Healthy fats & minerals' }
                    ]
                },
                'High Risk': {
                    title: 'Preventive Nutrition',
                    foods: [
                        { name: 'Salmon & Tuna', benefit: 'Cardiovascular support' },
                        { name: 'Avocados', benefit: 'Healthy fats & potassium' },
                        { name: 'Sweet Potatoes', benefit: 'Blood sugar regulation' },
                        { name: 'Greek Yogurt', benefit: 'Protein & probiotics' }
                    ]
                },
                'Moderate Risk': {
                    title: 'Balanced Nutrition',
                    foods: [
                        { name: 'Lean Proteins', benefit: 'Muscle maintenance' },
                        { name: 'Whole Grains', benefit: 'Fiber & energy' },
                        { name: 'Colorful Vegetables', benefit: 'Vitamins & minerals' },
                        { name: 'Low-fat Dairy', benefit: 'Calcium & protein' }
                    ]
                },
                'Low Risk': {
                    title: 'Maintenance Nutrition',
                    foods: [
                        { name: 'Fruits & Vegetables', benefit: 'General health maintenance' },
                        { name: 'Lean Meats', benefit: 'Protein source' },
                        { name: 'Complex Carbs', benefit: 'Sustained energy' },
                        { name: 'Healthy Fats', benefit: 'Essential nutrients' }
                    ]
                },
                'Very Low Risk': {
                    title: 'Wellness Nutrition',
                    foods: [
                        { name: 'Varied Diet', benefit: 'Optimal health maintenance' },
                        { name: 'Hydration', benefit: 'Water intake (8 glasses/day)' },
                        { name: 'Moderate Portions', benefit: 'Weight management' },
                        { name: 'Regular Meals', benefit: 'Metabolic health' }
                    ]
                }
            };

            const recommendation = foodRecommendations[riskLevel] || foodRecommendations['Moderate Risk'];
            
            const title = document.createElement('h6');
            title.textContent = recommendation.title;
            title.className = 'text-primary mb-3';
            foodContainer.appendChild(title);

            recommendation.foods.forEach(food => {
                const foodItem = document.createElement('div');
                foodItem.className = 'food-item';
                foodItem.innerHTML = `
                    <strong>${food.name}</strong>
                    <br><small class="text-muted">${food.benefit}</small>
                `;
                foodContainer.appendChild(foodItem);
            });
        }

        // Create risk score chart
        function createRiskScoreChart(predictions) {
            const ctx = document.getElementById('riskScoreChart').getContext('2d');
            
            if (riskScoreChart) {
                riskScoreChart.destroy();
            }

            riskScoreChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['30 Days', '60 Days', '90 Days'],
                    datasets: [{
                        label: 'Risk Score (%)',
                        data: [predictions.RISK_30D, predictions.RISK_60D, predictions.RISK_90D],
                        backgroundColor: [
                            'rgba(231, 76, 60, 0.8)',
                            'rgba(243, 156, 18, 0.8)',
                            'rgba(52, 152, 219, 0.8)'
                        ],
                        borderColor: [
                            'rgba(231, 76, 60, 1)',
                            'rgba(243, 156, 18, 1)',
                            'rgba(52, 152, 219, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Utility functions
        function getRiskClass(riskLabel) {
            const classes = {
                'Very High Risk': 'bg-danger',
                'High Risk': 'bg-warning',
                'Moderate Risk': 'bg-info',
                'Low Risk': 'bg-success',
                'Very Low Risk': 'bg-primary'
            };
            return classes[riskLabel] || 'bg-secondary';
        }

        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.main-container').insertBefore(alertDiv, document.querySelector('.main-container').firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // API functions
        async function updatePatientEmail(patientId, email) {
            try {
                const response = await fetch('/api/update-patient-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ patient_id: patientId, email: email })
                });
                
                if (response.ok) {
                    showAlert('Email updated successfully!', 'success');
                } else {
                    showAlert('Failed to update email', 'danger');
                }
            } catch (error) {
                console.error('Error updating email:', error);
                showAlert('Error updating email', 'danger');
            }
        }

        async function sendEmail(patientId) {
            try {
                const response = await fetch('/api/send-recommendations-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ patient_id: patientId })
                });
                
                if (response.ok) {
                    showAlert('Email sent successfully!', 'success');
                } else {
                    showAlert('Failed to send email', 'danger');
                }
            } catch (error) {
                console.error('Error sending email:', error);
                showAlert('Error sending email', 'danger');
            }
        }

        async function generatePDF(patientId) {
            try {
                window.open(`/api/export-patient-pdf/${patientId}`, '_blank');
                showAlert('PDF generated successfully!', 'success');
            } catch (error) {
                console.error('Error generating PDF:', error);
                showAlert('Error generating PDF', 'danger');
            }
        }

        async function sendBulkEmails() {
            try {
                const response = await fetch('/api/send-bulk-emails', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showAlert('Bulk emails sent successfully!', 'success');
                } else {
                    showAlert('Failed to send bulk emails', 'danger');
                }
            } catch (error) {
                console.error('Error sending bulk emails:', error);
                showAlert('Error sending bulk emails', 'danger');
            }
        }

        function exportToCSV() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "Patient ID,Age,Gender,Risk Score,Risk Level,Top Features,Email\n" +
                patientData.map(p => 
                    `${p.patient_id},${p.age},${p.gender === 1 ? 'Male' : 'Female'},${p.risk_30d}%,${p.risk_label},"${p.top_3_features || ''}","${p.email || ''}"`
                ).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "patient_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadPatientData();
            
            // Add event listener for limit change
            document.getElementById('limitSelect').addEventListener('change', loadPatientData);
        });
    </script>
</body>
</html>
